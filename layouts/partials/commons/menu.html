{{ $kind := .kind }}
{{ $items := .items }}
{{ $context := .context }}
{{ if $kind }}
  {{ $menu := partial "GetMenu" $kind }}
  {{ $items = $menu.items }}
{{ end }}
{{- $level := .level -}}
{{- $stop := .stop -}}
{{- $ignore_externals := .ignore_externals | default false -}}

{{- $options := index site.Params.menu $kind -}}
{{- $level_options := index $options (printf "level_%d" $level) -}}

{{- $dropdown := .dropdown -}}
{{- $dropdown_titled := (and site.Params.menu.dropdown.linkToLevel1 (eq $level 1)) -}}
{{- $dropdown_lvl1_summary := (and site.Params.menu.dropdown.level1_summary (eq $level 1)) -}}
{{- $dropdown_lvl2_summary := and site.Params.menu.dropdown.level2_summary (eq $level 2) -}}

{{ $extern_link := i18n "commons.link.blank" }}
<ul class="{{ if $level }}nav-level-{{ $level }}{{ end }} {{ .class }}">
  {{ range $items -}}
    {{- $slug := urlize .title -}}
    {{- $item_class := "" -}}
    {{- $link_class := "" -}}
    {{- $attr := "" -}}
    {{- $attr_title := printf "title=\"%s\"" .title -}}
    {{- $has_dropdown := false -}}
    {{ if eq $context.RelPermalink .target }}
      {{ $link_class = "active" }}
    {{ end }}
    {{ if eq $kind "social" }}
      {{- $item_class = printf .title | lower -}}
    {{ end }}
    {{- if gt (len .children) 0 -}}
      {{- $item_class = printf "%shas-children" $item_class -}}
      {{ range .children -}}
        {{- if eq $context.RelPermalink .target }}
          {{ $link_class = printf "%s %s" $link_class "has-children-active" }}
        {{ end }}
      {{ end -}}
    {{- end -}}
    {{- if and (gt (len .children) 0) $dropdown (eq $level 1) -}}
      {{- $has_dropdown = true -}}
      {{- $attr = printf "id=\"dropdown-%s\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"" $slug -}}
    {{- end -}}
    {{- if and (hasPrefix .target "http") (eq .kind "url") -}}
      {{ if eq $kind "upper-menu"}}
        {{- $link_class = "external-site" -}}
      {{ end }}
      {{ if eq $ignore_externals false }}
        {{- $attr = " target=\"_blank\" rel=\"noreferrer\"" -}}
      {{ end }}
      {{- $attr_title = printf "title=\"%s - %s\"" .title $extern_link -}}
    {{- end -}}
    {{- if or (ne $stop 1) (and (eq $stop 1) (ne .kind "blank")) -}}
      <li{{ if ne $item_class ""}} class="{{ $item_class }}"{{ end }}>

        {{- if ne .kind "blank" -}}
          <a href="{{ .target }}"{{ if ne $link_class ""}} class="{{ $link_class }}"{{ end }} {{ safeHTMLAttr $attr }} {{ safeHTMLAttr $attr_title }}>
            {{ .title }}
          </a>
          {{ partial "GetMenuSummary" (dict 
              "summary" $level_options.summary
              "path" .path
            )}}
        {{- else -}}
          <span class="{{ if ne $link_class ""}} {{ $link_class }}{{ end }}{{ if gt .level 1 }} disabled{{ end }}" {{ safeHTMLAttr $attr }}>{{ .title }}</span>
        {{- end -}}

      {{- if ne $stop $level -}}
        {{- $next_level := add $level 1 -}}
        {{- $next_level_option := index $options (printf "level_%d" $next_level) -}}

        {{- if $has_dropdown }}
          <div class="dropdown-menu {{- if $next_level_option.title }} is-titled {{- end -}} {{- if $dropdown_lvl2_summary }} children-titled {{- end }}" aria-labelledby="dropdown-{{ $slug }}">
            {{- if $next_level_option.title }}
              <div class="container">
                <div class="dropdown-menu-heading">
                  <a href="{{ .target }}" class="dropdown-menu-title">{{ .title }}</a>
                  {{ if .path }}
                    {{ with partial "GetMenuSummary" (dict 
                        "summary" $next_level_option.summary
                        "path" .path
                      )}}
                      <div class="dropdown-menu-lead">
                        {{ . }}
                      </div>
                    {{ end }}
                  {{ end }}
                </div>
            {{ end -}}
          {{- end -}}

          {{- if gt (len .children) 0 -}}
            {{- partial "commons/menu.html" (dict
                  "items" .children
                  "level" $next_level
                  "context" $context
              ) -}}
          {{- end -}}

          {{- if $has_dropdown -}}
              </div>
            {{- if $next_level_option.title }}
              </div>
            {{- end -}}
          {{- end -}}
        {{- end -}}
      </li>
    {{- end -}}
  {{ end -}}
  
  {{ if and site.Params.search.active (eq site.Params.search.position $kind) }}
    <li class="nav-search">
      {{ partial "header/search.html" (dict
          "position" $kind
          "context" .
      )}}
    </li>
  {{ end }}
  {{ if .i18n }}
    {{ partial "header/i18n.html" .context }}
  {{ end }}
</ul>
